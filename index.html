<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Wheel Scanner – Yahoo Options Proxy Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1rem;
      background: #020617;
      color: #e5e7eb;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.25rem;
    }
    p {
      margin-top: 0.25rem;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
      color: #cbd5f5;
    }
    .row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 0.5rem;
      margin-bottom: 0.5rem;
    }
    input[type="text"] {
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      min-width: 7rem;
      flex: 0 0 auto;
    }
    button {
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      border: none;
      font-size: 0.95rem;
      cursor: pointer;
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
      flex: 0 0 auto;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .small {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    #summary {
      margin-top: 0.75rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      background: #020617;
      border: 1px solid #1f2937;
      font-size: 0.9rem;
    }
    #output {
      margin-top: 0.75rem;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: #020617;
      padding: 0.75rem;
      border-radius: 0.5rem;
      max-height: 55vh;
      overflow: auto;
      border: 1px solid #1f2937;
      font-size: 0.8rem;
    }
    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: #020617;
      padding: 0 0.25rem;
      border-radius: 0.25rem;
    }
  </style>
</head>
<body>
  <h1>Yahoo Options via Public Proxy – Test</h1>
  <p>
    This page calls Yahoo Finance’s options API through a public CORS proxy
    (<code>api.allorigins.win</code>). If this works, we can later add
    0.5%/week CSP filtering on top.
  </p>

  <div class="row">
    <label for="ticker">Ticker:</label>
    <input id="ticker" type="text" value="AAPL" />
    <button id="btn" onclick="runTest()">Fetch Options</button>
  </div>

  <p class="small">
    It will request:
    <code>https://query1.finance.yahoo.com/v7/finance/options/&lt;TICKER&gt;</code><br />
    via:
    <code>https://api.allorigins.win/raw?url=&lt;encoded-URL&gt;</code>
  </p>

  <div id="summary">Waiting to run…</div>
  <div id="output"></div>

  <script>
    async function runTest() {
      const btn = document.getElementById('btn');
      const tickerInput = document.getElementById('ticker');
      const summaryEl = document.getElementById('summary');
      const outputEl = document.getElementById('output');

      let ticker = (tickerInput.value || '').trim().toUpperCase();
      if (!ticker) {
        alert('Please enter a ticker symbol, e.g. AMZN.');
        return;
      }

      btn.disabled = true;
      summaryEl.textContent = `Fetching options for ${ticker} via proxy…`;
      outputEl.textContent = '';

      const yahooUrl = `https://query1.finance.yahoo.com/v7/finance/options/${encodeURIComponent(ticker)}`;
      const proxiedUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(yahooUrl)}`;

      try {
        const res = await fetch(proxiedUrl);
        const status = res.status;
        const text = await res.text();

        // Try parsing as JSON
        let parsed = null;
        try {
          parsed = JSON.parse(text);
        } catch (jsonErr) {
          // not JSON – maybe HTML error page
        }

        if (!res.ok) {
          summaryEl.textContent = `Proxy HTTP status ${status}. Body (truncated):`;
          outputEl.textContent = text.slice(0, 1200);
          return;
        }

        if (!parsed || !parsed.optionChain || !parsed.optionChain.result || !parsed.optionChain.result.length) {
          summaryEl.textContent = `Got HTTP ${status}, but response did not look like Yahoo options JSON. Showing first part of body.`;
          outputEl.textContent = text.slice(0, 1200);
          return;
        }

        const result = parsed.optionChain.result[0];
        const quote = result.quote || {};
        const underlyingPrice = quote.regularMarketPrice;
        const expirations = result.expirationDates || [];
        const optionsList = result.options || [];
        const firstExpTs = expirations[0];
        const firstExpDate = firstExpTs ? new Date(firstExpTs * 1000) : null;
        const numPuts =
          optionsList.length > 0 && optionsList[0].puts
            ? optionsList[0].puts.length
            : 0;

        let summary = `✅ Success fetching options for ${ticker}.\n`;
        summary += `Underlying price: ${underlyingPrice}\n`;
        summary += `Expiration dates: ${expirations.length} total`;
        if (firstExpDate) {
          summary += ` (first: ${firstExpDate.toISOString().slice(0, 10)})`;
        }
        summary += `\nPuts in first expiration: ${numPuts}\n`;

        summaryEl.textContent = summary;

        // Show a pretty small JSON slice
        const pretty = JSON.stringify(parsed, null, 2);
        outputEl.textContent =
          'First ~1500 chars of parsed JSON:\n\n' + pretty.slice(0, 1500);

      } catch (err) {
        summaryEl.textContent = '❌ Error while calling proxy/Yahoo.';
        outputEl.textContent = String(err);
      } finally {
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
